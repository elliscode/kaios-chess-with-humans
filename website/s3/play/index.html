<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Chess with Humans</title>
  <meta name="description" content="Chess with Humans - Game">
  <meta name="author" content="Daniel Ellis Townsend">
  <meta name="viewport" content="width=device-width">
  <meta name="theme-color" content="#333" />
  <style>
body {
  font-family: sans-serif;
  margin: 0;
  padding: 0;
  background-color: #333;
  color: #ddd;
}
#content {
  display:flex;
  flex-direction:column;
  align-items: center;
}
.row {
  display:flex;
  width:fit-content;
}
.cell {
  width: calc(min(100vw, 8 * 100vh / 9) / 8);
  height: calc(min(100vw, 8 * 100vh / 9) / 8);
  font-size: calc(min(100vw, 100vh - 40px) / 9);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-weight: 900;
  user-select: none;
}
.info-bottom {
  width: calc(min(100vw, 8 * 100vh / 9));
  height: calc(100vh / 9);
  display: flex;
  flex-direction: column;
}
.info-bottom p {
  margin:0;
  padding:0;
}
.cell * {
  pointer-events: none;
}
.cell img, .cell svg {
  width: 100%;
  height: 100%;
}
.white {
  background-color: #C19A6B;
}
.black {
  background-color: #5C4033;
}
.black-piece {
  fill: #121212;
}
.white-piece {
  fill: #d9d9d9;
}
.graveyard {
  display:flex;
  flex-direction: row;
}
.graveyard img, .graveyard svg {
  width: calc(min(100vw, 8 * 100vh / 9) / 16);
  height: calc(min(100vw, 8 * 100vh / 9) / 16);
}
.modal-bg {
  position:fixed;
  top:0;
  left:0;
  width: 100%;
  height: 100%;
  z-index: 10;
  background-color: #3333338a;
  display:flex;
  justify-content: center;
  align-items: center;
}
.modal {
  width: calc(6 * min(100vw, 8 * 100vh / 9) / 8);
  height: calc(6 * min(100vw, 8 * 100vh / 9) / 8);
  background-color: #333;
  border: 1px solid black;
  display:flex;
  align-content: center;
  justify-content: center;
  align-items: center;
  flex-wrap: wrap;
}
.modal button {
  cursor: pointer;
  margin:0;
  padding:0;
  width: calc(min(100vw, 8 * 100vh / 9) / 4);
  height: calc(min(100vw, 8 * 100vh / 9) / 4);
  border-width: 0;
  margin: 5px;
}
.modal img, .modal svg {
  width: calc(min(100vw, 8 * 100vh / 9) / 4);
  height: calc(min(100vw, 8 * 100vh / 9) / 4);
  pointer-events: none;
}
.hidden {
  display:none;
}
.previous {
  box-shadow: inset 0 0 0 5px rgb(255, 219, 59); /*rgb(196, 196, 196)*/
}
.check {
  box-shadow: inset 0 0 0 5px rgb(255, 128, 0);
}
.cell:hover, .potential {
  box-shadow: inset 0 0 0 5px dodgerblue;
}
.active, .active:hover {
  box-shadow: inset 0 0 0 5px rgb(44, 225, 31);
}
.stalemate {
  box-shadow: inset 0 0 0 5px rgb(128, 128, 128);
}
.checkmate {
  box-shadow: inset 0 0 0 5px rgb(182, 0, 0);
}
  </style>
</head>

<body>
  <div id="content">
    <div id="chess-board-holder"></div>
    <div class="info-bottom">
      <div id="white-graveyard" class="graveyard"></div>
      <div id="black-graveyard" class="graveyard"></div>
    </div>
  </div>
  <p class="hidden">The game ID you requested is: <span id="game-text"></span></p>
  <div id="promotion-modal" class="modal-bg" style="display:none;">
    <div class="modal">
      <button class="promote-button" id="promote-to-q" onclick="performMove(event);">Queen</button>
      <button class="promote-button" id="promote-to-r" onclick="performMove(event);">Rook</button>
      <button class="promote-button" id="promote-to-b" onclick="performMove(event);">Bishop</button>
      <button class="promote-button" id="promote-to-n" onclick="performMove(event);">Knight</button>
    </div>
  </div>
  <div class="hidden">
    <svg id="piece-b" width="1in" height="1in" viewBox="0 0 25.4 25.4" version="1.1" id="svg1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs1" /><g id="layer4" style="display:inline"><path id="path6" style="display:inline;fill-opacity:1;stroke-width:2.54;stroke-linejoin:round;paint-order:markers stroke fill" d="m 7.5902372,12.12275 c -0.089115,4.079741 2.1125326,4.996595 2.1125326,4.996595 h 0.9870202 3.98477 0.98702 c 0,0 2.202164,-0.916854 2.113049,-4.996595 0,0 -0.509747,-4.3047753 -3.528969,-5.3625459 0,0 -0.469764,4.7525959 -1.566014,5.2985619 0.841266,-2.816562 0.892802,-4.0728443 0.06124,-5.7520422 C 10.195283,6.5231695 7.6690544,8.9111112 7.5902372,12.12275 Z" /><circle style="display:inline;fill-opacity:1;stroke-width:2.54;stroke-linejoin:round;paint-order:markers stroke fill" id="path5" cx="12.682432" cy="4.9851866" r="1.651" /><path id="rect7" style="display:inline;fill-opacity:1;stroke-width:2.54;stroke-linejoin:round;paint-order:markers stroke fill" d="M 9.7668484,17.676933 8.292003,19.207589 c 0,0 -0.6361539,0.0028 -1.6965373,0.01602 -1.0603833,0.01319 -1.1766723,1.128097 -1.1766723,1.128097 l -0.00362,1.714107 h 6.3148596 1.939934 6.31486 l -0.0036,-1.714107 c 0,0 -0.116288,-1.114907 -1.176672,-1.128097 -1.060384,-0.01319 -1.696537,-0.01602 -1.696537,-0.01602 l -1.475362,-1.530656 z" /></g></svg> 
    <svg id="piece-k" width="1in" height="1in" viewBox="0 0 25.4 25.4" version="1.1" id="svg1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs1" /><g id="layer5" style="display:inline"><path id="path7" style="fill-opacity:1;stroke-width:4.38912;stroke-linejoin:round;paint-order:markers stroke fill" d="m 11.412827,2.8646175 0.01082,1.9788189 -2.1744804,-0.016969 0.046426,2.4937634 2.1273474,0.00923 -0.0102,2.2876809 2.574374,6e-7 0.0094,-2.2876809 2.108793,-0.00923 0.04553,-2.4937637 -2.155925,0.016969 -0.0077,-1.9788186 z" /><path id="path9" style="fill-opacity:1;stroke-width:2.54;stroke-linejoin:round;paint-order:markers stroke fill" d="M 7.7674844,7.7088317 C 7.0302567,7.6972527 6.2174616,7.8657069 5.586739,8.2953592 4.7457754,8.8682287 4.0952216,10.077851 3.9196573,10.998554 c -0.1755644,0.920703 -0.00403,1.537236 0.4278808,2.410188 0.4319097,0.872953 1.757296,1.797864 2.298051,2.500623 0.5407549,0.702761 1.0361124,1.621606 1.0361124,1.621606 H 17.718299 c 0,0 0.495357,-0.918845 1.036112,-1.621606 0.540756,-0.702759 1.866142,-1.62767 2.298051,-2.500623 0.43191,-0.872952 0.603446,-1.489485 0.427881,-2.410188 C 21.304779,10.077851 20.654225,8.8682287 19.813261,8.2953592 18.972298,7.7224894 17.807689,7.613809 16.930233,7.7775613 c -0.877457,0.1637523 -1.454545,0.6053054 -2.072742,1.2614214 -0.618196,0.656117 -1.13779,1.7919363 -1.396297,2.6354983 -0.258506,0.843563 -0.204257,1.658465 -0.248047,2.297535 -0.04379,0.639069 -0.04496,1.531689 -0.04496,1.531689 h -0.01292 -0.910539 -0.01292 c 0,0 -0.0012,-0.89262 -0.04496,-1.531689 -0.04379,-0.63907 0.01046,-1.453972 -0.248046,-2.297535 C 11.680301,10.830919 11.160706,9.6950997 10.542509,9.0389827 9.9243125,8.3828667 9.3472233,7.9413136 8.4697671,7.7775613 8.2504031,7.7366232 8.013227,7.7126913 7.7674844,7.7088317 Z" /><path id="rect9" style="fill-opacity:1;stroke-width:2.54;stroke-linejoin:round;paint-order:markers stroke fill" d="m 8.0945964,18.37123 c -1.300231,0.02223 -2.2024496,0.996867 -2.2024496,1.963705 v 1.964221 h 4.0571167 5.2580765 4.057634 v -1.964221 c 0,-0.966838 -0.902736,-1.941479 -2.202966,-1.963705 H 15.20734 9.9492635 Z" /></g></svg> 
    <svg id="piece-n" width="1in" height="1in" viewBox="0 0 25.4 25.4" version="1.1" id="svg1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs1" /><g id="layer6" style="display:inline"><path id="path10" style="fill-opacity:1;stroke-width:2.54;stroke-linejoin:round;paint-order:markers stroke fill" d="m 10.78542,3.8745106 c -0.421055,0.00361 -0.818555,0.076481 -0.818555,0.076481 l 0.090434,1.9750733 c 0,0 -1.8119773,1.450446 -2.4287925,2.2928833 -0.6168153,0.8424372 -0.8815213,1.9454858 -1.2712403,2.6334318 -0.389719,0.687945 -0.8890761,1.03555 -0.9989054,1.521354 -0.1098293,0.485803 -0.069211,0.718539 0.1586466,1.157552 0.2278576,0.439013 0.7962211,1.017124 1.3167155,1.226282 0.5204945,0.209158 1.101831,0.219658 1.5663127,0.02222 0.4644817,-0.197438 0.3593288,-0.593979 0.9989054,-1.066602 0.639577,-0.472622 2.259996,-1.032323 2.973979,-1.453141 0.713982,-0.420819 1.36219,-0.95343 1.36219,-0.95343 0,0 0.08049,1.068521 -0.158646,1.702738 -0.239138,0.634217 -0.764548,1.272972 -1.384929,1.90686 -0.62038,0.633889 -1.623052,1.084324 -2.3610957,1.793689 -0.7380444,0.709366 -1.6910424,1.805748 -2.0205486,2.45153 -0.3295061,0.645783 -0.246491,0.737953 -0.2950724,1.135332 -0.048581,0.397378 0.013436,1.228865 0.013436,1.228865 H 20.063923 l 0.03617,-1.723926 c 0,0 -0.505715,0.0961 -0.861963,-1.005623 -0.356249,-1.10173 0.542397,-4.213085 0.466638,-5.603276 -0.07576,-1.39019 -0.157837,-1.782153 -0.520899,-2.680973 -0.363062,-0.8988202 -0.97865,-1.8006181 -1.68,-2.5879563 C 16.802522,7.1365377 15.832006,6.2947574 15.006351,5.8578521 14.180695,5.4209467 12.736205,5.1994943 12.736205,5.1994943 c 0,0 -0.745428,-1.0156884 -1.248503,-1.2257649 -0.188653,-0.078779 -0.44965,-0.1013829 -0.702282,-0.099219 z m 0.0067,3.8989868 A 0.50800002,0.50800002 0 0 1 11.300099,8.2819935 0.50800002,0.50800002 0 0 1 10.79212,8.7899728 0.50800002,0.50800002 0 0 1 10.28414,8.2819935 0.50800002,0.50800002 0 0 1 10.79212,7.7734974 Z" /></g></svg> 
    <svg id="piece-p" width="1in" height="1in" viewBox="0 0 25.4 25.4" version="1.1" id="svg1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs1" /><g id="layer3" style="display:inline"><ellipse style="fill-opacity:1;stroke-width:2.54;stroke-linejoin:round;paint-order:markers stroke fill" id="path4" cx="12.676746" cy="7.672976" rx="3.0496955" ry="3.0480001" /><rect style="fill-opacity:1;stroke-width:2.54;stroke-linejoin:round;paint-order:markers stroke fill" id="rect4" width="6.3499999" height="1.524" x="9.5017462" y="10.500606" ry="0.76200002" /><path id="rect5" style="fill-opacity:1;stroke-width:2.54;stroke-linejoin:round;paint-order:markers stroke fill" d="m 11.583789,10.50485 c 0,0 -0.700852,3.763578 -1.275891,4.833296 -0.575038,1.069719 -3.1550453,2.056681 -3.1336583,3.543453 l 0.027388,1.893425 H 18.19889 l 0.02687,-1.893425 C 18.24715,17.394827 15.667141,16.407865 15.092102,15.338146 14.517064,14.268428 13.816728,10.50485 13.816728,10.50485 l -1.116211,0.01447 z" /></g></svg> 
    <svg id="piece-q" width="1in" height="1in" viewBox="0 0 25.4 25.4" version="1.1" id="svg1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs1" /><g id="layer7" style="display:inline"><g id="layer8" style="display:inline"><path id="path15" style="display:inline;fill-opacity:1;stroke-width:2.54;stroke-linejoin:round;paint-order:markers stroke fill" d="M 7.7674844,7.7088317 C 7.0302567,7.6972527 6.2174616,7.8657069 5.586739,8.2953592 4.7457754,8.8682287 4.0952216,10.077851 3.9196573,10.998554 c -0.1755644,0.920703 -0.00403,1.537236 0.4278808,2.410188 0.4319097,0.872953 1.757296,1.797864 2.298051,2.500623 0.5407549,0.702761 1.0361124,1.621606 1.0361124,1.621606 H 17.718299 c 0,0 0.495357,-0.918845 1.036112,-1.621606 0.540756,-0.702759 1.866142,-1.62767 2.298051,-2.500623 0.43191,-0.872952 0.603446,-1.489485 0.427881,-2.410188 C 21.304779,10.077851 20.654225,8.8682287 19.813261,8.2953592 18.972298,7.7224894 17.807689,7.613809 16.930233,7.7775613 c -0.877457,0.1637523 -1.454545,0.6053054 -2.072742,1.2614214 -0.618196,0.656117 -1.13779,1.7919363 -1.396297,2.6354983 -0.258506,0.843563 -0.204257,1.658465 -0.248047,2.297535 -0.04379,0.639069 -0.04496,1.531689 -0.04496,1.531689 h -0.01292 -0.910539 -0.01292 c 0,0 -0.0012,-0.89262 -0.04496,-1.531689 -0.04379,-0.63907 0.01046,-1.453972 -0.248046,-2.297535 C 11.680301,10.830919 11.160706,9.6950997 10.542509,9.0389827 9.9243125,8.3828667 9.3472233,7.9413136 8.4697671,7.7775613 8.2504031,7.7366232 8.013227,7.7126913 7.7674844,7.7088317 Z" /><path id="path16" style="display:inline;fill-opacity:1;stroke-width:2.54;stroke-linejoin:round;paint-order:markers stroke fill" d="m 8.0945964,18.37123 c -1.300231,0.02223 -2.2024496,0.996867 -2.2024496,1.963705 v 1.964221 h 4.0571167 5.2580765 4.057634 v -1.964221 c 0,-0.966838 -0.902736,-1.941479 -2.202966,-1.963705 H 15.20734 9.9492635 Z" /><circle style="fill-opacity:1;stroke-width:2.54;stroke-linejoin:round;paint-order:markers stroke fill" id="path17" cx="12.7" cy="6.4301882" r="2.54" /></g></g></svg> 
    <svg id="piece-r" width="1in" height="1in" viewBox="0 0 25.4 25.4" version="1.1" id="svg1" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs1" /><g id="layer2" style="display:inline"><path style="fill-opacity:1;stroke-width:2.54;stroke-linejoin:round;paint-order:markers stroke fill" d="m 6.8187555,4.1924322 -0.036125,3.6125557 1.6979011,1.6256497 8.7423834,0.036126 1.697901,-1.7701522 V 4.1924322 l -2.492663,0.036126 v 1.7701522 l -1.517274,0.036125 -0.03613,-1.8424033 -4.046062,0.036126 0.03613,1.7340265 H 9.2752932 V 4.1924322 Z" id="path1" /><path style="fill-opacity:1;stroke-width:2.54;stroke-linejoin:round;paint-order:markers stroke fill" d="m 17.042287,10.189274 0.32513,6.141345 H 8.3721544 l 0.252879,-6.17747 z" id="path2" /><path style="fill-opacity:1;stroke-width:2.54;stroke-linejoin:round;paint-order:markers stroke fill" d="M 5.9156167,21.099192 19.498825,21.207568 V 18.67878 c 0,0 0.102971,-1.34038 -2.059157,-1.372771 -2.162128,-0.03239 -6.809582,-0.03615 -9.2120158,-0.03613 -2.4024342,2.1e-5 -2.3269929,1.462479 -2.3269929,1.462479 z" id="path3" /></g></svg> 
  </div>
  <script>
const boardDiv = document.getElementById('chess-board-holder');
// const whoseTurn = document.getElementById('whose-turn');
const promotionModal = document.getElementById('promotion-modal');
const uciMoveNotation = /^([a-h]\d)([a-h]\d)([rbnq]?)$/;
let data = undefined;
let joinAttempts = 0;
function loadPage() {
  const gameText = document.getElementById("game-text");
  const parts = window.location.pathname.split('/');
  gameText.innerText = parts[parts.length - 1];
  if (gameText) {
    let attemptToJoin = true;
    const currentGamesListString = localStorage.getItem('chess-with-humans-games-list');
    if (currentGamesListString) {
      const currentGamesList = JSON.parse(currentGamesListString)
      const currentGame = currentGamesList.find(x=>x.game_id==gameText.innerText);
      if (currentGame) {
        attemptToJoin = false;
        fetch('https://bau0ghibt2.execute-api.us-east-1.amazonaws.com/dev/get', {
          method: "POST",
          body: JSON.stringify({
            "game_id": currentGame.game_id,
            "password": currentGame.password
          })
        }).then(x=>x.json()).then(jsonData=>{
          data = jsonData;
          // const pre = document.createElement('pre');
          // pre.innerText = JSON.stringify(data, undefined, 2);
          // document.body.appendChild(pre);
          buildChessBoard();
          drawChessBoard();
        })
      }
    }
    if (attemptToJoin && joinAttempts < 2) {
      fetch('https://bau0ghibt2.execute-api.us-east-1.amazonaws.com/dev/join', {
        method: "POST",
        body: JSON.stringify({
          "game_id": gameText.innerText
        })
      }).then(x=>x.json()).then(jsonData=>{
        data = jsonData;
        // const pre = document.createElement('pre');
        // pre.innerText = JSON.stringify(data, undefined, 2);
        // document.body.appendChild(pre);
        currentGamesList = [];
        const currentGamesListString = localStorage.getItem('chess-with-humans-games-list');
        if (currentGamesListString) {
          currentGamesList = JSON.parse(currentGamesListString);
        }
        currentGamesList.push({
          game_id: data.game_id,
          password: data.player_two_password
        });
        localStorage.setItem('chess-with-humans-games-list', JSON.stringify(currentGamesList));
        loadPage();
      });
      joinAttempts = joinAttempts + 1;
    }
  }
}
function buildChessBoard() {
  let board = document.createElement('div');
  let colIds = ['a','b','c','d','e','f','g','h'];
  let rowIds = ['1','2','3','4','5','6','7','8'];
  if (data.player_id == 1) {
    rowIds.reverse()
  } else {
    colIds.reverse()
  }
  let white = true;
  for (let rowId of rowIds) {
    let row = document.createElement('div');
    row.classList.add('row');
    for (let colId of colIds) {
      let cell = document.createElement('div');
      cell.addEventListener('click', touchSquare);
      cell.id = colId + rowId;
      cell.classList.add('cell');
      cell.classList.add(white ? 'white' : 'black');
      white = !white;
      row.appendChild(cell);
    }
    white = !white;
    board.appendChild(row);
  }
  boardDiv.appendChild(board);
  // fill in the buttons for promotion
  for (let promoteButton of Array.from(document.getElementsByClassName('promote-button'))) {
    let pieceType = promoteButton.id.slice(-1);
    let color = data.whose_turn == 1 ? 'white' : 'black';
    let clonedPiece = document.getElementById(`piece-${pieceType.toLowerCase()}`).cloneNode(true);
    clonedPiece.id = '';
    clonedPiece.classList.add(`promotion-piece`);
    promoteButton.innerHTML = '';
    promoteButton.appendChild(clonedPiece);
  }
}
function drawChessBoard() {
  Array.from(document.querySelectorAll('.cell')).forEach(x=>x.innerText='');
  Array.from(document.getElementsByTagName('img')).forEach(x=>x.remove());
  Array.from(document.getElementsByClassName('tombstone')).forEach(x=>x.remove());
  Array.from(document.querySelectorAll('.previous')).forEach(x=>x.classList.remove('previous'));
  Array.from(document.querySelectorAll('.check')).forEach(x=>x.classList.remove('check'));
  Array.from(document.querySelectorAll('.checkmate')).forEach(x=>x.classList.remove('checkmate'));
  let kingStatus = undefined;
  if (data.is_checkmate) { 
    kingStatus = 'checkmate';
  } else if (data.is_check) {
    kingStatus = 'check';
  } else if (data.is_stalemate) {
    kingStatus = 'stalemate'
  }
  kingInStatus = undefined;
  if (kingStatus && data.whose_turn == 1) {
    kingInStatus = 'K';
  } else if (kingStatus && data.whose_turn == 2) {
    kingInStatus = 'k';
  }
  for (let pieceType of Object.keys(data.pieces)) {
    for (let coord of data.pieces[pieceType]) {
      let square = document.querySelector(`#${coord}`);
      let color = pieceType.toLowerCase() != pieceType ? 'white' : 'black';
      let clonedPiece = document.getElementById(`piece-${pieceType.toLowerCase()}`).cloneNode(true);
      clonedPiece.id = '';
      clonedPiece.classList.add(`${color}-piece`);
      square.appendChild(clonedPiece);
      if (kingInStatus == pieceType) {
        square.classList.add(kingStatus);
      }
    }
  }
  promotionModal.style.display = 'none';
  let graveyard = Array.from(data.graveyard);
  let pieceTaken = [];
  if (data.piece_taken) {
    pieceTaken = Object.keys(data.piece_taken);
  }
  for (let pieceType of ['Q', 'R', 'B', 'N', 'P', 'q', 'r', 'b', 'n', 'p']) {
    while (graveyard.includes(pieceType)) {
      graveyard.splice(graveyard.indexOf(pieceType), 1);
      let color = pieceType.toLowerCase() != pieceType ? 'white' : 'black';
      let clonedPiece = document.getElementById(`piece-${pieceType.toLowerCase()}`).cloneNode(true);
      clonedPiece.id = '';
      clonedPiece.classList.add(`${color}-piece`);
      clonedPiece.classList.add(`tombstone`);
      if (pieceTaken.includes(pieceType)) {
        pieceTaken.pop();
        clonedPiece.classList.add(`previous`);
      }
      let graveyardDom = document.getElementById(`${color}-graveyard`);
      graveyardDom.insertBefore(clonedPiece, graveyardDom.firstElementChild);
    }
  }
  if (data.previous_move) {
    const start = data.previous_move.substring(0,2);
    const end = data.previous_move.substring(2,4);
    document.querySelector(`#${start}`).classList.add('previous');
    document.querySelector(`#${end}`).classList.add('previous');
  }
}
function touchSquare(event) {
  let action = 'select-square'
  if (data.whose_turn != data.player_id) {
    action = 'clear'
  } else if (event.target.classList.contains('active')) {
    action = 'clear'
  } else if (event.target.classList.contains('potential')) {
    action = 'make-move'
  }
  if (action == 'select-square') {
    Array.from(document.querySelectorAll('.potential')).forEach(x=>x.classList.remove('potential'));
    Array.from(document.querySelectorAll('.active')).forEach(x=>x.classList.remove('active'));
    event.target.classList.add('active');
    for (let legalMove of data.legal_moves) {
      if (legalMove.startsWith(event.target.id)) {
        let destinationSquareString = legalMove.substring(2, 4);
        let destinationSquare = document.getElementById(destinationSquareString);
        destinationSquare.classList.add('potential');
      }
    }
  } else if (action == 'make-move') {
    let startSpot = document.querySelector('.active').id;
    let endSpot = event.target.id;
    let move = startSpot + endSpot;
    let possibleMoves = data.legal_moves.filter(x=>x.startsWith(move));
    if (possibleMoves.length == 1) {
      performMove(move);
    } else if (possibleMoves.length > 1) {
      document.getElementById('promote-to-b').setAttribute('move', possibleMoves.find(x=>x.endsWith('b')));
      document.getElementById('promote-to-n').setAttribute('move', possibleMoves.find(x=>x.endsWith('n')));
      document.getElementById('promote-to-q').setAttribute('move', possibleMoves.find(x=>x.endsWith('q')));
      document.getElementById('promote-to-r').setAttribute('move', possibleMoves.find(x=>x.endsWith('r')));
      const promoteButtons = Array.from(document.getElementsByClassName('promote-button'));
      promoteButtons.forEach(x=>x.classList.remove('white'));
      promoteButtons.forEach(x=>x.classList.remove('black'));
      promoteButtons.forEach(x=>x.classList.add(event.target.classList.contains('white') ? 'white' : 'black'));
      promoteButtons.forEach(x=>x.querySelector('img, svg').classList.add(data.whose_turn == 1 ? `white-piece` : 'black-piece'));
      promotionModal.style.display = 'flex';
    }
  } else {
    Array.from(document.querySelectorAll('.potential')).forEach(x=>x.classList.remove('potential'));
    Array.from(document.querySelectorAll('.active')).forEach(x=>x.classList.remove('active'));
  }
}
function performMove(move) {
  Array.from(document.querySelectorAll('.potential')).forEach(x=>x.classList.remove('potential'));
  Array.from(document.querySelectorAll('.active')).forEach(x=>x.classList.remove('active'));
  if (!(typeof move == 'string') && move.target) {
    move = move.target.getAttribute('move');
  }
  const currentGamesListString = localStorage.getItem('chess-with-humans-games-list');
  if (currentGamesListString) {
    const currentGamesList = JSON.parse(currentGamesListString)
    const currentGame = currentGamesList.find(x=>x.game_id==data.game_id);
    fetch('https://bau0ghibt2.execute-api.us-east-1.amazonaws.com/dev/move', {
      method: "POST",
      body: JSON.stringify({
        "game_id": currentGame.game_id,
        "password": currentGame.password,
        "move": move,
      })
    }).then(x=>x.json()).then(jsonData=>{
      data = jsonData;
      // const pre = document.createElement('pre');
      // pre.innerText = JSON.stringify(data, undefined, 2);
      // document.body.appendChild(pre);
      drawChessBoard();
    })
  }
}
let socket = undefined;
let creatingSocket = false;
function startConnection(event) {
  if (creatingSocket) {
    return;
  }
  creatingSocket = true;
  // Create a new WebSocket connection
  socket = new WebSocket('wss://59ms2wie22.execute-api.us-east-1.amazonaws.com/dev/');

  // When the connection is established
  socket.addEventListener('open', (event) => {
    console.log('Connected to WebSocket server.');
    // register the websocket with the game id and the password
    const currentGamesListString = localStorage.getItem('chess-with-humans-games-list');
    if (currentGamesListString) {
      const currentGamesList = JSON.parse(currentGamesListString)
      const currentGame = currentGamesList.find(x=>x.game_id==data.game_id);
      socket.send(JSON.stringify({ action: 'register', message: {"game_id": currentGame.game_id, "password": currentGame.password}}));
      // socket created, you can run this code again if needed
      creatingSocket = false;
    }
  });

  // When a message is received
  socket.addEventListener('message', (event) => {
    console.log('Message from server:', event.data);
    let messageData = JSON.parse(event.data);
    if (messageData.event == 'move' && data.whose_turn != data.player_id) {
      const currentGamesListString = localStorage.getItem('chess-with-humans-games-list');
      if (currentGamesListString) {
        const currentGamesList = JSON.parse(currentGamesListString)
        const currentGame = currentGamesList.find(x=>x.game_id==data.game_id);
        fetch('https://bau0ghibt2.execute-api.us-east-1.amazonaws.com/dev/get', {
          method: "POST",
          body: JSON.stringify({
            "game_id": currentGame.game_id,
            "password": currentGame.password
          })
        }).then(x=>x.json()).then(jsonData=>{
          data = jsonData;
          drawChessBoard();
        });
      }
    }
  });

  // When the connection closes
  socket.addEventListener('close', (event) => {
    console.log('Connection closed:', event.code, event.reason);
  });

  // When an error occurs
  socket.addEventListener('error', (error) => {
    console.error('WebSocket error:', error);
  });
}
function maintainWebSocket(event) {
  if (data && data.game_id && (!socket || socket.readyState != WebSocket.OPEN)) {
    startConnection(event);
  }
}
loadPage();
maintainWebSocket();
setInterval(maintainWebSocket, 1000);
  </script>

</body>

</html>